
// [{
// 	"id": "files",
// 	"value": "Files",
// 	"open": true,
// 	"type": "folder",
// 	"date": "new Date(2014, 2, 10, 16, 10)",
// 	"data": [{
// 		"id": "documents",
// 		"value": "Documents",
// 		"date": "new Date(2014, 2, 10, 16, 10)",
// 		"type": "folder",
// 		"open": true,
// 		"data": [{
// 			"id": "presentations",
// 			"value": "Presentations",
// 			"type": "folder",
// 			"date": "new Date(2014, 2, 10, 16, 10)",
// 			"data": [{
// 				"id": "pres1",
// 				"value": "October 2014.ppt",
// 				"type": "pp",
// 				"date": "new Date(2014, 2, 10, 16, 10)",
// 				"size": "12830"
// 			}, {
// 				"id": "pres2",
// 				"value": "June 2014.ppt",
// 				"type": "pp",
// 				"date": "new Date(2014, 2, 10, 16, 10)",
// 				"size": "20100"
// 			}, {
// 				"id": "pres3",
// 				"value": "April 2014.ppt",
// 				"type": "pp",
// 				"date": "new Date(2014, 2, 10, 16, 10)",
// 				"size": "15750"
// 			}]
// 		}, {
// 			"id": "reports",
// 			"value": "Reports",
// 			"type": "folder",
// 			"date": "new Date(2014, 2, 10, 16, 10)",
// 			"open": true,
// 			"data": [{
// 				"id": "usa",
// 				"value": "USA",
// 				"type": "folder",
// 				"date": "new Date(2014, 2, 10, 16, 10)",
// 				"data": [{
// 					"id": "salesUS",
// 					"value": "Sales USA.ppt",
// 					"type": "excel",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "12830"
// 				}, {
// 					"id": "overviewUS",
// 					"value": "Overview USA.doc",
// 					"type": "doc",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "15030"
// 				}, {
// 					"id": "pricesUS",
// 					"value": "Prices USA.ppt",
// 					"type": "excel",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "15830"
// 				}, {
// 					"id": "productsUS",
// 					"value": "Products USA.ppt",
// 					"type": "excel",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "20830"
// 				}]
// 			}, {
// 				"id": "europe",
// 				"value": "Europe",
// 				"type": "folder",
// 				"date": "new Date(2014, 2, 10, 16, 10)",
// 				"data": [{
// 					"id": "salesEurope",
// 					"value": "Sales Europe.ppt",
// 					"type": "archive",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "12830"
// 				}, {
// 					"id": "pricesEurope",
// 					"value": "Prices Europe.ppt",
// 					"type": "excel",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "15830"
// 				}, {
// 					"id": "productsEurope",
// 					"value": "Products Europe.ppt",
// 					"type": "excel",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "20830"
// 				}, {
// 					"id": "overviewEurope",
// 					"value": "Overview Europe.doc",
// 					"type": "doc",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "15030"
// 				}]
// 			}, {
// 				"id": "asia",
// 				"value": "Asia",
// 				"type": "folder",
// 				"date": "new Date(2014, 2, 10, 16, 10)",
// 				"data": [{
// 					"id": "salesAsia",
// 					"value": "Sales Asia.ppt",
// 					"type": "excel",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "12083"
// 				}, {
// 					"id": "pricesAsia",
// 					"value": "Prices Asia.ppt",
// 					"type": "excel",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "15830"
// 				}, {
// 					"id": "overviewAsia",
// 					"value": "Overview Asia.doc",
// 					"type": "doc",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "15030"
// 				}, {
// 					"id": "productsAsia",
// 					"value": "Products Asia.ppt",
// 					"type": "excel",
// 					"date": "new Date(2014, 2, 10, 16, 10)",
// 					"size": "20830"
// 				}]
// 			}]
// 		}]
// 	}, {
// 		"id": "video",
// 		"value": "Video",
// 		"type": "folder",
// 		"date": "new Date(2014, 2, 10, 16, 12)",
// 		"data": [{
// 			"id": "video1",
// 			"value": "New Year 2013.avi",
// 			"icon": "file-video-o",
// 			"type": "video",
// 			"date": "new Date(2014, 2, 10, 16, 12)",
// 			"size": "25030000",
// 			"pId": "video"
// 		}, {
// 			"id": "video2",
// 			"value": "Presentation.avi",
// 			"icon": "file-video-o",
// 			"type": "video",
// 			"date": "new Date(2014, 2, 10, 16, 12)",
// 			"size": "11072000",
// 			"pId": "video"
// 		}, {
// 			"id": "video3",
// 			"value": "Conference.avi",
// 			"icon": "file-video-o",
// 			"type": "video",
// 			"date": "new Date(2014, 2, 10, 16, 12)",
// 			"size": "31256000",
// 			"pId": "video"
// 		}]
// 	}]
// }]



/*
 * Version 0.0.1
 * Date de modification 31/01/2015
 *
 * ScanNAS.js
 *  Gère la gestion des Scans d'arborescence
 * 
 * Conçu par l'équipe de NNM :
 *  - Jérémy Young
 */

'use strict';
let check       = require('check-types');
let fs          = require('fs');
let path        = require('path');

// let originPath  = '/media/HDD1/NAS01/MultiMedia/';
let originPath  = '/home/pi';
// let results     = [];

module.exports.scan = function(origin, params) {
  
  if (origin !== undefined && check.string(origin) && process.env.HOME != '/home/pi')
  {
    originPath = origin;
  }
  
  // TODO discover tree
  // http://stackoverflow.com/questions/11194287/convert-a-directory-structure-in-the-filesystem-to-json-with-node-js
  
    let walk = function(dir, done) {
      var results = [];
      fs.readdir(dir, function(err, list) {
      if (err) return done(err);
      var pending = list.length;
      var i = 0;
      if (!pending) return done(null, {id: ++i, value: path.basename(dir), type: 'folder', data: results});
      
      list.forEach(function(file) {
        file = path.resolve(dir, file);
        fs.stat(file, function(err, stat) {
          // Check if is a directory and if is begin by '.'
          if (stat && stat.isDirectory() && file.indexOf('.') == -1) {
            walk(file, function(err, res) {
              var objFile = {
                id: ++i,
                value: path.basename(file),
                type: 'folder',
                date: stat.ctime,
                data: res
              };
              results.push(objFile);
              // console.log(res);
              // results = results.concat(res);
              if (!--pending) done(null, results);
            });
            // console.log(file);
          } else {
            var objFile = {
              id: ++i,
              value: path.basename(file),
              // type: 'ToDefineButOlmostAFile',
              type: 'pp',
              date: stat.ctime,
              size: stat.size
            };
            results.push(objFile);
            // console.log(objFile);
            // console.log(stat.ctime);//size
            if (!--pending) done(null, results);
          }
        });
      });
    });
  };
  
  // var walk = function(dir, done) {
  //   fs.readdir(dir, function(err, list) {
  //     if (err) return done(err);
  //     var i = 0;
  //     (function next() {
  //       var file = list[i++];
  //       if (!file) return done(null, results);
  //       file = dir + '/' + file;
  //       fs.stat(file, function(err, stat) {
  //         if (stat && stat.isDirectory()) {
  //           walk(file, function(err, res) {
  //             results = results.concat(res);
  //             next();
  //           });
  //         } else {
  //           results.push(file);
  //           console.log(file);
  //           next();
  //         }
  //       });
  //     })();
  //   });
  // };
  
  walk(originPath, (err, results) => {
    if (err) throw err;
    var data = {
      socket: params.socket,
      result: results
      };
    
    console.log('Done');
    params.ServerEvent.emit('TreeRead', data);
  });
  
  
};